<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="initial-scale=1.0, width=device-width"/><link rel="apple-touch-icon" sizes="57x57" href="/favicon-57x57.png"/><link rel="apple-touch-icon" sizes="60x60" href="/favicon-60x60.png"/><link rel="apple-touch-icon" sizes="72x72" href="/favicon-72x72.png"/><link rel="apple-touch-icon" sizes="76x76" href="/favicon-76x76.png"/><link rel="apple-touch-icon" sizes="114x114" href="/favicon-114x114.png"/><link rel="apple-touch-icon" sizes="120x120" href="/favicon-120x120.png"/><link rel="apple-touch-icon" sizes="144x144" href="/favicon-144x144.png"/><link rel="apple-touch-icon" sizes="152x152" href="/favicon-152x152.png"/><link rel="apple-touch-icon" sizes="180x180" href="/favicon-180x180.png"/><link rel="icon" type="image/svg+xml" href="/favicon.svg"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png"/><link rel="icon" type="image/png" sizes="192x192" href="/favicon-192x192.png"/><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico"/><link rel="icon" type="image/x-icon" href="/favicon.ico"/><meta name="msapplication-TileImage" content="/favicon-144x144.png"/><meta name="msapplication-config" content="/browserconfig.xml"/><meta name="theme-color" content="#0E151B"/><link rel="alternate" type="application/rss+xml" href="https://reuben.science/rss.xml"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="@_reubn"/><meta name="twitter:creator" content="@_reubn"/><meta property="og:locale" content="en_GB"/><title>Same Origin Cloudflare Analytics | Reuben</title><meta name="robots" content="index,follow"/><meta name="googlebot" content="index,follow"/><meta name="description" content="Reverse Engineering Cloudflare Web Analytics"/><meta property="og:type" content="article"/><meta property="article:published_time" content="2020-12-31T00:00:00.000Z"/><meta property="article:author" content="Reuben"/><meta property="article:tag" content="dev"/><meta property="og:title" content="Same Origin Cloudflare Analytics"/><meta property="og:description" content="Reverse Engineering Cloudflare Web Analytics"/><meta property="og:image" content="https://reuben.science/.assets/e41ee54e0805c7e26260bb6a236f7add/header.webp"/><meta property="og:image:alt" content="Same Origin Cloudflare Analytics"/><meta property="og:image:width" content="1000"/><meta property="og:image:height" content="400"/><meta property="og:site_name" content="reuben.science"/><script type="application/ld+json">{
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      {
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https://reuben.science/",
          "name": "Home"
        }
      },{
        "@type": "ListItem",
        "position": 2,
        "item": {
          "@id": "https://reuben.science/posts",
          "name": "Posts"
        }
      },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https://reuben.science/posts/cloudflare-analytics",
          "name": "Same Origin Cloudflare Analytics"
        }
      }
     ]
  }</script><script type="application/ld+json">{
    "@context": "https://schema.org",
    "@type": "Article",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "undefined"
    },
    "headline": "Same Origin Cloudflare Analytics",
    "image": [
      
     ],
    "datePublished": "2020-12-31T00:00:00.000Z",
    "dateModified": "2020-12-31T00:00:00.000Z",
    "author": [{"@type": "Person","name": "Reuben"}],
    "publisher": {
      "@type": "Organization",
      "name": "Reuben",
      "logo": {
        "@type": "ImageObject",
        "url": "undefined"
      }
    },
    "description": "Reverse Engineering Cloudflare Web Analytics"
  }</script><meta name="next-head-count" content="43"/><link rel="preload" href="/_next/static/css/16a3bba4695b9180bd90.css" as="style"/><link rel="stylesheet" href="/_next/static/css/16a3bba4695b9180bd90.css" data-n-g=""/><link rel="preload" href="/_next/static/css/47756754eb4c7df730b5.css" as="style"/><link rel="stylesheet" href="/_next/static/css/47756754eb4c7df730b5.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-e7a279300235e161e32a.js"></script><script src="/_next/static/chunks/webpack-b51cb379df8af448720f.js" defer=""></script><script src="/_next/static/chunks/framework-3af989d3dbeb77832f99.js" defer=""></script><script src="/_next/static/chunks/main-18e5535ffc85f4a7d113.js" defer=""></script><script src="/_next/static/chunks/pages/_app-241c6119708a04d09111.js" defer=""></script><script src="/_next/static/chunks/440-7649974f41db5cba109b.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-d09f5d2e4cc3e1aa93dd.js" defer=""></script><script src="/_next/static/wFjfd_zMoHF1WW8g8t7X_/_buildManifest.js" defer=""></script><script src="/_next/static/wFjfd_zMoHF1WW8g8t7X_/_ssgManifest.js" defer=""></script></head><body><div id="__next"><section class="_app_app__7eKMU _app_loadGlitchFix__3JLhN" id="app"><header class="styles_header__1VY7O"><svg role="banner" class="styles_logo__CS-TL  styles_svg__2WrhB" viewBox="0 0 994 994"><defs><linearGradient x1="0%" y1="0%" x2="99.9884439%" y2="99.9884439%" id="orange"><stop stop-color="hsl(14, 100%, 61%)" offset="0.0115561319%"></stop><stop stop-color="hsl(32, 97%, 57%)" offset="100%"></stop></linearGradient><linearGradient x1="100%" y1="100%" x2="0%" y2="0%" id="yellow"><stop stop-color="hsl(56, 97%, 57%)" offset="0%"></stop><stop stop-color="hsl(51, 100%, 61%)" offset="100%"></stop></linearGradient><linearGradient x1="8.8817842e-14%" y1="8.8817842e-14%" x2="100%" y2="100%" id="red"><stop stop-color="hsl(0, 100%, 66%)" offset="0%"></stop><stop stop-color="hsl(0, 97%, 57%)" offset="100%"></stop></linearGradient><linearGradient x1="0%" y1="0%" x2="100%" y2="100%" id="blue"><stop stop-color="hsl(180, 90%, 48%)" offset="0%"></stop><stop stop-color="hsl(201, 97%, 50%)" offset="100%"></stop></linearGradient><linearGradient x1="0%" y1="-1.77635684e-13%" x2="100%" y2="100%" id="purple"><stop stop-color="hsl(244, 100%, 66%)" offset="0%"></stop><stop stop-color="hsl(274, 97%, 57%)" offset="100%"></stop></linearGradient><linearGradient x1="100%" y1="100%" x2="-7.10542736e-13%" y2="7.10542736e-13%" id="green"><stop stop-color="hsl(117, 100%, 66%)" offset="0%"></stop><stop stop-color="hsl(158, 97%, 57%)" offset="100%"></stop></linearGradient></defs><g><g transform="translate(-565.000000, -233.000000)"><g transform="translate(1062.000000, 730.000000) rotate(-45.000000) translate(-1062.000000, -730.000000) translate(712.000000, 378.000000)"><path d="M400,20.0660172 L400,230.066017 C400,241.111712 391.045695,250.066017 380,250.066017 L270,250.066017 C258.954305,250.066017 250,259.020322 250,270.066017 L250,280.066017 C250,291.111712 258.954305,300.066017 270,300.066017 L680,300.066017 C691.045695,300.066017 700,309.020322 700,320.066017 L700,680.066017 C700,691.111712 691.045695,700.066017 680,700.066017 L320,700.066017 C308.954305,700.066017 300,691.111712 300,680.066017 L300,620.066017 C300,609.020322 308.954305,600.066017 320,600.066017 L580,600.066017 C591.045695,600.066017 600,591.111712 600,580.066017 L600,570.066017 C600,559.020322 591.045695,550.066017 580,550.066017 L320,550.066017 C308.954305,550.066017 300,541.111712 300,530.066017 L300,470.066017 C300,459.020322 308.954305,450.066017 320,450.066017 L580,450.066017 C591.045695,450.066017 600,441.111712 600,430.066017 L600,420.066017 C600,409.020322 591.045695,400.066017 580,400.066017 L170,400.066017 C158.954305,400.066017 150,391.111712 150,380.066017 L150,170.066017 C150,159.020322 158.954305,150.066017 170,150.066017 L280,150.066017 C291.045695,150.066017 300,141.111712 300,130.066017 L300,120.066017 C300,109.020322 291.045695,100.066017 280,100.066017 L120,100.066017 C108.954305,100.066017 100,109.020322 100,120.066017 L100,380.066017 C100,391.111712 91.045695,400.066017 80,400.066017 L20,400.066017 C8.954305,400.066017 1.3527075e-15,391.111712 0,380.066017 L0,20.0660172 C-1.3527075e-15,9.02032218 8.954305,0.066017178 20,0.066017178 L380,0.066017178 C391.045695,0.066017178 400,9.02032218 400,20.0660172 Z" class="styles_type__T5qCq styles_lodFlat__3b8er"></path><g transform="translate(0.000000, 0.066017)"><g transform="translate(449.933983, 0.000000)"><rect class="styles_square__1WhS8 styles_lodFlat__3b8er styles_t1__166eK styles_dim__3uRUr" x="0.066017178" y="0" rx="20px"></rect><rect class="styles_square__1WhS8 styles_lodFlat__3b8er styles_t2__33Q4o styles_dim__3uRUr" x="2.84217094e-14" y="149.93" rx="20px"></rect><rect class="styles_square__1WhS8 styles_lodFlat__3b8er styles_t3__cK8OC styles_dim__3uRUr" x="150" y="149.93" rx="20px"></rect><rect class="styles_square__1WhS8 styles_lodRainbowGradient__2CiRJ styles_t1__166eK undefined styles_interactive__3kkKs " x="0.066017178" y="0" rx="20px"></rect><rect class="styles_square__1WhS8 styles_lodRainbowGradient__2CiRJ styles_t2__33Q4o undefined styles_interactive__3kkKs " x="2.84217094e-14" y="149.93" rx="20px"></rect><rect class="styles_square__1WhS8 styles_lodRainbowGradient__2CiRJ styles_t3__cK8OC undefined styles_interactive__3kkKs " x="150" y="149.93" rx="20px"></rect></g><g transform="translate(0.000000, 452.933983)"><rect class="styles_square__1WhS8 styles_lodFlat__3b8er styles_b1__2wieY styles_dim__3uRUr" x="5.68434189e-14" y="0.066017178" rx="20px"></rect><rect class="styles_square__1WhS8 styles_lodFlat__3b8er styles_b2__15mx1 styles_dim__3uRUr" x="150.066017" y="1.13686838e-13" rx="20px"></rect><rect class="styles_square__1WhS8 styles_lodFlat__3b8er styles_b3__3y9_a styles_dim__3uRUr" x="149.933983" y="149.996017" rx="20px"></rect><rect class="styles_square__1WhS8 styles_lodRainbowGradient__2CiRJ styles_b1__2wieY undefined styles_interactive__3kkKs " x="5.68434189e-14" y="0.066017178" rx="20px"></rect><rect class="styles_square__1WhS8 styles_lodRainbowGradient__2CiRJ styles_b2__15mx1 undefined styles_interactive__3kkKs " x="150.066017" y="1.13686838e-13" rx="20px"></rect><rect class="styles_square__1WhS8 styles_lodRainbowGradient__2CiRJ styles_b3__3y9_a undefined styles_interactive__3kkKs " x="149.933983" y="149.996017" rx="20px"></rect></g></g></g></g></g></svg><nav class="styles_nav__92QWc"><a class="styles_link__3mBj1 " style="--link-underline:linear-gradient(135deg, var(--colours-pink-red) 0%, var(--colours-pink-red-hint) 100%)" href="/">Home</a><a class="styles_link__3mBj1 " style="--link-underline:linear-gradient(135deg, var(--colours-blue) 0%, var(--colours-blue-hint) 100%)" href="/posts">Posts</a><a class="styles_link__3mBj1 " style="--link-underline:linear-gradient(135deg, var(--colours-indigo) 0%, var(--colours-indigo-hint) 100%)" href="/snippets">Snippets</a></nav></header><main class="_app_content__3Z-Um"><article class="styles_post__v5a44"><section class="styles_categories__1BdoG"><a class=" styles_category__1Yob3" style="--category-background:linear-gradient(135deg, var(--colours-blue) 0%, var(--colours-blue-hint) 100%)" href="/categories/dev">dev</a></section><h1 class="styles_title__8NRYT">Same Origin Cloudflare Analytics</h1><h2 class="styles_description__1Ei_s">Reverse Engineering Cloudflare Web Analytics</h2><noscript><style>[data-noscript="no"]{display: none!important}</style><img id="0.4360576079503251" src="/.assets/e41ee54e0805c7e26260bb6a236f7add/header.webp" srcSet="/.assets/e41ee54e0805c7e26260bb6a236f7add/header.webp 1x, /.assets/b4c8c4d679df0f2680653fae8de9d115/header.webp 2x" width="1000" height="400" class="styles_image__1yRQR styles_headerImage__3khy4 styles_loading__Jmk8v" loading="lazy" alt="Header Image" data-noscript="yes"/></noscript><img id="0.4360576079503251" src="" srcSet="" width="1000" height="400" class="styles_image__1yRQR styles_headerImage__3khy4 styles_loading__Jmk8v" loading="lazy" alt="Header Image" data-noscript="no"/><span class="styles_info__1D6yJ"><time dateTime="12/31/2020">12/31/2020</time><time time="PD0T0H4M" aria-label="Reading Time">4<!-- --> min<!-- -->s</time></span><span class="styles_body__hfQyP" id="HACK-POST-cloudflare-analytics"><p>Cloudflare&#x27;s new analytics offering &#x27;Cloudflare Web Analytics&#x27; promises a solution to the dichotomy of information vs privacy. Their free tier operates using a traditional <code>JS</code> beacon script loaded from Cloudflare&#x27;s own domain <code>static.cloudflareinsights.com</code>, that reports back to <code>cloudflareinsights.com</code>. Cloudflare promises their solution to be &#x27;privacy-first&#x27;, and while I have very little doubt about it being the case, it won&#x27;t be long before ad-blockers and other privacy-conscious tools block it - as a 3<sup>rd</sup> party resource.</p><h2 id="reverse-engineering-the-beacon"><a href="#reverse-engineering-the-beacon">Reverse Engineering the Beacon</a></h2><p>The script Cloudflare loads is heavily minified, and while not intentionally obfuscated, is almost impossible to read. I tried looking for stray source maps and the like, but didn&#x27;t find any. Instead I used <a href="https://lelinhtinh.github.io/de4js/"><code>de4js</code></a> with the <a href="https://github.com/lelinhtinh/de4js/blob/master/userscript/de4js_helper.user.js"><code>unreadable</code></a> add-on, and then ran it through <a href="https://prettier.io/">Prettier</a>. The <code>unreadable</code> extension uses data from <a href="http://jsnice.org/">JSNice</a>, and tries to rename variables back to their likely name using a statistical model<sup id="fnref-1"><a href="#fn-1" class="footnote-ref">1</a></sup>. This works pretty well, but isn&#x27;t infallible, so you have to have your whits about you and not blindly trust that a variable named <code>url</code>, is even a <code>URL</code>, for example.</p><p>Once inside, the code showed a number of options that are documented (or that I could find).</p><p>There&#x27;s the option to include custom tags in the beacon requests</p><pre><span><button class="clickToCopy" onmousedown="COPY_FN(event)" onmouseup="CLEAR_FN(event)">Copy</button></span><code class="language-js"><span class="token spread operator">...</span>

<span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access">__cfBeaconCustomTag</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token string">&quot;object&quot;</span> <span class="token operator">!=</span> <span class="token keyword">typeof</span> <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access">__cfBeaconCustomTag</span> <span class="token operator">||</span> <span class="token known-class-name class-name">Array</span><span class="token punctuation">.</span><span class="token method function property-access">isArray</span><span class="token punctuation">(</span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access">__cfBeaconCustomTag</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">warn</span><span class="token punctuation">(</span><span class="token string">&#x27;Invalid custom tag format. Please use the following format: { &quot;first_key&quot;: &quot;first_value&quot;, &quot;second_key&quot;: &quot;second_value&quot; }&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    state<span class="token punctuation">.</span><span class="token property-access">ct</span> <span class="token operator">=</span> <span class="token function">applyChange</span><span class="token punctuation">(</span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access">__cfBeaconCustomTag</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token spread operator">...</span>
</code></pre><p>This is cool but let&#x27;s keep digging.</p><p>Here we find what we&#x27;ve been looking for, an option to configure the <code>URL</code> the beacon will pass the <strong>R</strong>eal <strong>U</strong>ser <strong>M</strong>etrics to.</p><pre><span><button class="clickToCopy" onmousedown="COPY_FN(event)" onmouseup="CLEAR_FN(event)">Copy</button></span><code class="language-js"><span class="token spread operator">...</span>

<span class="token keyword">var</span> initial <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token property-access">token</span>
    <span class="token operator">?</span> params<span class="token punctuation">.</span><span class="token property-access">send</span> <span class="token operator">&amp;&amp;</span> params<span class="token punctuation">.</span><span class="token property-access">send</span><span class="token punctuation">.</span><span class="token property-access">to</span>
            <span class="token operator">?</span> params<span class="token punctuation">.</span><span class="token property-access">send</span><span class="token punctuation">.</span><span class="token property-access">to</span>
            <span class="token operator">:</span> <span class="token string">&quot;https://cloudflareinsights.com/cdn-cgi/rum&quot;</span>
    <span class="token operator">:</span> <span class="token keyword null nil">null</span><span class="token punctuation">;</span>

<span class="token spread operator">...</span>
</code></pre><p>Looking further up in the script, we can see that the <code>params</code> can be taken from the <code>script</code> tag or, interestingly for us, from <code>window.__cfBeacon</code>.</p><pre><span><button class="clickToCopy" onmousedown="COPY_FN(event)" onmouseup="CLEAR_FN(event)">Copy</button></span><code class="language-js">
<span class="token spread operator">...</span>
<span class="token keyword">var</span> t <span class="token operator">=</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">currentScript</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token string">&quot;function&quot;</span> <span class="token operator">==</span> <span class="token keyword">typeof</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">querySelector</span> <span class="token operator">?</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;script[data-cf-beacon]&quot;</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token spread operator">...</span>

<span class="token keyword">var</span> params <span class="token operator">=</span> <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access">__cfBeacon</span><span class="token punctuation">;</span>

<span class="token spread operator">...</span>

<span class="token keyword">var</span> paramJson <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token method function property-access">getAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;data-cf-beacon&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>paramJson<span class="token punctuation">)</span> <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
        params <span class="token operator">=</span> <span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">parse</span><span class="token punctuation">(</span>paramJson<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token spread operator">...</span>

</code></pre><p>So, we can pick our own <code>URL</code> using <code class="language-js"><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access">__cfBeacon</span> <span class="token operator">=</span> <span class="token punctuation">{</span>token<span class="token operator">:</span> <span class="token constant">ANALYTICS_TOKEN</span><span class="token punctuation">,</span> send<span class="token operator">:</span> <span class="token punctuation">{</span>to<span class="token operator">:</span> <span class="token constant">ENDPOINT_URL</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></p><h2 id="cdn-cgi"><a href="#cdn-cgi">cdn-cgi</a></h2><p>My first thought was to change this to a Cloudflare Worker proxy, sitting on the same origin. However, this isn&#x27;t even necessary...</p><p>Cloudflare&#x27;s <code>CDN</code> network includes a &#x27;secret&#x27; <code>/cdn-cgi</code> directory on sites it proxies. The best-known use of this is the <code>/cdn-cgi/trace</code> document, that details information about the user&#x27;s interaction with the Cloudflare network.</p><pre><span><button class="clickToCopy" onmousedown="COPY_FN(event)" onmouseup="CLEAR_FN(event)">Copy</button></span><code class="language-ini" metastring="; /cdn-cgi/trace"><span class="token key attr-name">fl</span><span class="token punctuation">=</span><span class="token value attr-value">21f439</span>
<span class="token key attr-name">h</span><span class="token punctuation">=</span><span class="token value attr-value">cloudflare.com</span>
<span class="token key attr-name">ip</span><span class="token punctuation">=</span><span class="token value attr-value">2b00:24e3:6444:5301:fcf9:4321:29f7:abcd</span>
<span class="token key attr-name">ts</span><span class="token punctuation">=</span><span class="token value attr-value">1609427929.302</span>
<span class="token key attr-name">visit_scheme</span><span class="token punctuation">=</span><span class="token value attr-value">https</span>
<span class="token key attr-name">uag</span><span class="token punctuation">=</span><span class="token value attr-value">Mozilla/5.0 (Macintosh; Intel Mac OS X 11_1_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4356.6 Safari/537.36</span>
<span class="token key attr-name">colo</span><span class="token punctuation">=</span><span class="token value attr-value">LHR</span>
<span class="token key attr-name">http</span><span class="token punctuation">=</span><span class="token value attr-value">http/2</span>
<span class="token key attr-name">loc</span><span class="token punctuation">=</span><span class="token value attr-value">GB</span>
<span class="token key attr-name">tls</span><span class="token punctuation">=</span><span class="token value attr-value">TLSv1.3</span>
<span class="token key attr-name">sni</span><span class="token punctuation">=</span><span class="token value attr-value">plaintext</span>
<span class="token key attr-name">warp</span><span class="token punctuation">=</span><span class="token value attr-value">off</span>
<span class="token key attr-name">gateway</span><span class="token punctuation">=</span><span class="token value attr-value">off</span>
<span class="token key attr-name">gateway_account_id</span><span class="token punctuation">=</span><span class="token value attr-value">nil</span>
</code></pre><p>It turns out that a lot of Cloudflare&#x27;s services make use of this path, including their email protection, and their <code>rocket loader</code> scripts, as well as many other things<sup id="fnref-2"><a href="#fn-2" class="footnote-ref">2</a></sup>.</p><p>More pertinent to our needs, as seen in the default <code>URL</code>, <code>/cdn-cgi/rum</code> exists, and it&#x27;s live on all Cloudflare-proxied sites - same origin 👌.</p><blockquote><p>✨ Take Home Message</p><p><code class="language-js"><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access">__cfBeacon</span> <span class="token operator">=</span> <span class="token punctuation">{</span>token<span class="token operator">:</span> <span class="token constant">ANALYTICS_TOKEN</span><span class="token punctuation">,</span> send<span class="token operator">:</span> <span class="token punctuation">{</span>to<span class="token operator">:</span> <span class="token string">&#x27;/cdn-cgi/rum&#x27;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></p><p>will provide us with a same-origin destination for our requests</p></blockquote><p>To solve the initial request being 3<sup>rd</sup> Party, I suggest just serving the <code>beacon.min.js</code>, file yourself, as I haven&#x27;t found it exposed in the same way.</p><h2 id="worth-it"><a href="#worth-it">Worth it?</a></h2><p>I&#x27;m in two minds about solving this. On one hand its somewhat futile as it only defeats <code>DNS</code> based blocking, <code>uBlock</code> or other <code>HTTP</code>-level blockers could quite easily write a rule to block this, on the other hand, Cloudflare Web Analytics is the only free limitless offering I&#x27;ve found that doesn&#x27;t track users (not even using their IP address)<sup id="fnref-3"><a href="#fn-3" class="footnote-ref">3</a></sup>, and doesn&#x27;t require cookies - so maybe it is worth trying.</p><p>There are many ways to solve the issues of simple pattern blocking, using &#x27;Cloudflare Workers&#x27;, or literally any other proxy service - but I want a simple stack and don&#x27;t want to be bounded by usage limits more than necessary - optimistic, I know!</p><p>Cloudflare Web Analytics is still in beta, so it&#x27;s quite possible these features will be documented or removed 😢 in the future.</p><div class="footnotes"><hr/><ol><li id="fn-1" ref-number="1"><a href="http://www.nice2predict.org/">http://www.nice2predict.org/</a><a href="#fnref-1" class="footnote-backref">↩</a></li><li id="fn-2" ref-number="2"><a href="https://www.google.com/search?q=%22/cdn-cgi/%22">https://www.google.com/search?q=&quot;/cdn-cgi/&quot;</a><a href="#fnref-2" class="footnote-backref">↩</a></li><li id="fn-3" ref-number="3"><a href="https://www.cloudflare.com/en-gb/web-analytics/">https://www.cloudflare.com/en-gb/web-analytics/</a><a href="#fnref-3" class="footnote-backref">↩</a></li></ol></div></span></article><script>window.__HACK_GLOBAL = {...(window.__HACK_GLOBAL || {}), ["cloudflare-analytics"]: document.getElementById('HACK-POST-cloudflare-analytics').innerHTML}</script></main><footer class="styles_footer__3X29e"><p class="styles_icons__9pmlP"><a href="//unsplash.com/@re" class="styles_unsplash__2dXtF" title="Unsplash"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="styles_icon__1r7NH"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg></a><a href="//github.com/reubn" class="styles_github__2s_Vd" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="styles_icon__1r7NH"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a><a href="mailto:click.to.reveal@email.com" class="styles_mail__GwmOI" title="Email"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="styles_icon__1r7NH"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></a><a href="//twitter.com/reubn_" class="styles_twitter__3GQFb" title="Twitter"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="styles_icon__1r7NH"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a><a href="//instagram.com/reubn" class="styles_instagram__3QWSe" title="Instagram"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 132 132" width="0" height="0"><defs><linearGradient id="instagram" gradientTransform="rotate(45)"><stop offset="0" stop-color="#fd5"></stop><stop offset=".1" stop-color="#fd5"></stop><stop offset=".5" stop-color="#ff543e"></stop><stop offset="1" stop-color="#c837ab"></stop></linearGradient></defs></svg><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="styles_icon__1r7NH"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg></a></p><a href="//github.com/reubn/reuben.science" class="styles_code__3w15N" title="Source Code"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="styles_icon__1r7NH"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></svg></a></footer></section></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"slug":"cloudflare-analytics","metadata":{"title":"Same Origin Cloudflare Analytics","description":"Reverse Engineering Cloudflare Web Analytics","emoji":"⛅️","date":"2020-12-31T00:00:00.000Z","category":["dev"],"image":{"id":0.4360576079503251,"size":{"width":1000,"height":400},"src":"/.assets/e41ee54e0805c7e26260bb6a236f7add/header.webp","srcSet":"/.assets/e41ee54e0805c7e26260bb6a236f7add/header.webp 1x, /.assets/b4c8c4d679df0f2680653fae8de9d115/header.webp 2x"},"readingTime":{"mins":4}}},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"cloudflare-analytics"},"buildId":"wFjfd_zMoHF1WW8g8t7X_","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>